!(function(b){if("object"==typeof exports&&"undefined"!=typeof module){module.exports=b()}else{if("function"==typeof define&&define.amd){define([],b)}else{var a;"undefined"!=typeof window?a=window:"undefined"!=typeof global?a=global:"undefined"!=typeof self&&(a=self),a.mssql=b()}}})(function(){var d,b,a;return(function c(f,k,h){function g(n,l){if(!k[n]){if(!f[n]){var i=typeof require=="function"&&require;if(!l&&i){return i(n,!0)}if(e){return e(n,!0)}throw new Error("Cannot find module '"+n+"'")}var m=k[n]={exports:{}};f[n][0].call(m.exports,function(o){var p=f[n][1][o];return g(p?p:o)},m,m.exports,c,f,k,h)}return k[n].exports}var e=typeof require=="function"&&require;for(var j=0;j<h.length;j++){g(h[j])}return g})({1:[function(h,g,f){var e=g.exports=new Class();e.property("connection",new ActiveXObject("ADODB.CONNECTION")).property("connectionconfig",{database:"mssql",serverip:"127.0.0.1",username:"",password:""});e.property("tryConnect",function(){var l=this.connectionconfig,j=this.connection,o=[],m=false;o.push(["Provider=sqloledb","Data Source="+l.serverip,"Initial Catalog="+l.database,"User Id="+l.username,"Password="+l.password,""].join(";"));o.push(["Driver={SQL Server}","Server="+l.serverip,"Database="+l.database,"Uid="+l.username,"Pwd="+l.password,""].join(";"));for(var k=0;k<o.length;k++){try{j.open(o[k]);m=true;break}catch(n){}}return{status:m,object:j,cmd:l}});e.instance(event).extend(event);e.define("setup",function(i){return this.property("connectionconfig",_.extend(_.clone(this["private"]("connectionconfig")),i))});e.define("listen",function(){var k=new Date().getTime();var i=this["private"]("tryConnect")();var j=new Date().getTime()-k;if(i.status){this.emit("connect.success",i.object,j)}else{this.emit("connect.error",i.object,j,i.cmd)}return this});e.define("destory",function(){var i=this["private"]("connection");this.emit("connect.destory",i);try{i.Close()}catch(j){}})},{}],2:[function(h,g,f){var e=g.exports=new Class(function(i){i["private"]("connect").BeginTrans();this.property("context",i)});e.property("tasker",Promise.resolve());e.instance(event).extend(event);e.define("task",function(n,i){var m=this["private"]("context"),k=this["private"]("tasker"),l=this["private"]("dbo"),j=this["private"]("connect");this.property("tasker",k.then(function(o){return new Promise(function(q,p){try{if(_.isFunction(n)){n(q,p,o)}else{q(o)}}catch(r){if(_.isFunction(i)){p(i(r,o))}else{p(r)}}})}));return this});e.define("stop",function(){var i=this;this["private"]("tasker").then(function(j){i["private"]("context")["private"]("connect").CommitTrans();i.emit("task.success",j)})["catch"](function(j){i["private"]("context")["private"]("connect").RollbackTrans();i.emit("task.error",j)})})},{}],3:[function(h,g,f){var i=g.exports=new Class(function(l,n,m){var k=l["private"]("dbo"),j=l["private"]("connect");this.property("context",l);this.property("dbo",k);this.property("connect",j);_.isString(n)&&k.Open(n,j,1,m?m:1)});i.define("each",function(o){var m=this,k=this["private"]("dbo"),l=0,j=[];k.MoveFirst();while(!k.Eof){if(_.isFunction(o)){var n=o.call(m,k,l);if(!_.isUndefined(n)){j.push(n)}}l++;k.MoveNext()}return j});i.define("toJSON",function(){return this.each(function(j,l){var k={};for(var l=0;l<j.fields.count;l++){k[j.fields(l).name]=j.fields(l).value}return k})});i.define("toArray",function(){try{var j=this["private"]("dbo"),k=j.GetRows().toArray();return e(k,j.Fields.Count)}catch(l){if(process.env.SERIES_ENV==="development"){throw new Error("Series plugin module [mssql.query] Error: "+l.message)}return[]}});i.define("exec",function(l){var j=this["private"]("dbo");if(j.RecordCount>1){return this.each(l)}else{if(_.isFunction(l)){var k=l.call(this,j,0);if(!_.isUndefined(k)){return k}}}});function e(l,o){var k=l.length/o,q=[],p;for(var n=0;n<k;n++){q[n]=new Array();p=n*o;for(var m=0;m<o;m++){q[n][m]=l[p+m]}}return q}},{}],4:[function(h,g,f){var j=h("./transation.js"),i=h("./query.js"),e=g.exports=new Class(function(k){this.property("connect",k)});e.property("dbo",new ActiveXObject("ADODB.RECORDSET"));e.instance(event).extend(event);e.define("insert",function(p,k,r){var o=this,n=this["private"]("dbo"),m=this["private"]("connect"),l=[];n.open("SELECT * FROM "+p,m,1,2);var q=function(t){n.AddNew();_.each(t,function(v,u){n(u)=v});n.Update();if(_.isFunction(r)){var s=r.call(o,n,m);if(!_.isUndefined(s)){l.push(s)}}};if(_.isArray(k)){_.each(k,function(s){q(s)})}else{q(k)}if(l.length===1){return l[0]}else{if(l.length>1){return l}}});e.define("update",function(s,n,k,r){var m=this,p=this["private"]("dbo"),u=this["private"]("connect"),q=[];var t="SELECT * FROM "+s;if(!_.isNull(n)){t+=" WHERE "+n}p.open("SELECT * FROM "+s,u,2,3);var l=p.RecordCount;if(l>0){if(l>1){p.MoveFirst();while(!p.Eof){if(_.isFunction(r)){var o=r.call(m,p,u);if(!_.isUndefined(o)){q.push(o)}}_.each(k,function(w,v){p(v)=w});p.Update();p.MoveNext()}}else{if(_.isFunction(r)){var o=r.call(m,p,u);if(!_.isUndefined(o)){q.push(o)}}_.each(k,function(w,v){p(v)=w});p.Update()}}if(q.length===1){return q[0]}else{if(q.length>1){return q}}});e.define("remove",function(r,m,q){var l=this,o=this["private"]("dbo"),t=this["private"]("connect"),p=[];var s="SELECT * FROM "+r;if(!_.isNull(m)){s+=" WHERE "+m}o.open("SELECT * FROM "+r,t,2,3);var k=o.RecordCount;if(k>0){if(k>1){o.MoveFirst();while(!o.Eof){if(_.isFunction(q)){var n=q.call(l,o,t);if(!_.isUndefined(n)){p.push(n)}}o.Delete();o.MoveNext()}}else{if(_.isFunction(q)){var n=q.call(l,o,t);if(!_.isUndefined(n)){p.push(n)}}o.Delete()}}if(p.length===1){return p[0]}else{if(p.length>1){return p}}});e.define("destory",function(){this["private"]("dbo").close()});e.define("transaction",function(){return new j(this)});e.define("query",function(l,k){return new i(this,l,k)})},{"./transation.js":2,"./query.js":3}],5:[function(h,f,e){var i=h("./query.js");var g=f.exports=new Class(function(k,j){this.property("connect",j);this.property("command",k);this["private"]("cmd").ActiveConnection=j;this["private"]("cmd").CommandType=g.CommandType.STOREDPROC;this["private"]("cmd").Prepared=true});g.property("cmd",new ActiveXObject("Adodb.Command"));g.property("params",{});g.property("dbo",null);g.property("geted",false);g.define("addParm",function(j,l,m){var n=this["private"]("params"),k=this["private"]("cmd");n[j]=k.CreateParameter(j);n[j].Value=l||null;n[j].Direction=m||1;return this});g.define("addInput",function(j,m,l,k){this["private"]("params")[j]=this["private"]("cmd").CreateParameter(j,l,g.ParameterDirection.INPUT,k,m);return this});g.define("addInputInt",function(j,k){return this.addInput(j,k,g.DataType.DBTYPE_I4,4)});g.define("addInputBigInt",function(j,k){return this.addInput(j,k,g.DataType.DBTYPE_I8,8)});g.define("addInputVarchar",function(j,l,k){return this.addInput(j,l,g.DataType.VARCHAR,k||50)});g.define("addOutput",function(j,l,k){this["private"]("params")[j]=this["private"]("cmd").CreateParameter(j,l,g.ParameterDirection.OUTPUT,k);return this});g.define("addOutputInt",function(j){return this.addOutput(j,g.DataType.DBTYPE_I4,4)});g.define("addOutputBigInt",function(j){return this.addOutput(j,g.DataType.DBTYPE_I8,8)});g.define("addOutputVarchar",function(j,k){return this.addOutput(j,g.DataType.VARCHAR,k||50)});g.define("addReturn",function(j,l,k){this["private"]("params")[j]=this["private"]("cmd").CreateParameter(j,l,g.ParameterDirection.RETURNVALUE,k);return this});g.define("create",function(){var k=this["private"]("cmd"),l=this["private"]("params");k.CommandText=this["private"]("command");for(var j in l){if(!l.hasOwnProperty(j)){continue}k.Parameters.Append(l[j])}this.property("dbo",k.execute());return new i(this)});g.define("destory",function(){this.provate("dbo").Close()});g.define("get",function(j){var m=this["private"]("geted"),n=this["private"]("params"),l=this["private"]("cmd");if(!m){for(var k in n){if(!n.hasOwnProperty(k)){continue}if(n[k].Direction>1){n[k].value=l(k).value}}this.property("geted",true)}if(!n.hasOwnProperty(j)){return null}return n[j]});g.ParameterDirection={INPUT:1,INPUTOUTPUT:3,OUTPUT:2,RETURNVALUE:4};g.DataType={ARRAY:8192,DBTYPE_I8:20,DBTYPE_BYTES:128,DBTYPE_BOOL:11,DBTYPE_BSTR:8,DBTYPE_HCHAPTER:136,DBTYPE_STR:129,DBTYPE_CY:6,DBTYPE_DATE:7,DBTYPE_DBDATE:133,DBTYPE_DBTIME:134,DBTYPE_DBTIMESTAMP:135,DBTYPE_DECIMAL:14,DBTYPE_R8:5,DBTYPE_EMPTY:0,DBTYPE_ERROR:10,DBTYPE_FILETIME:64,DBTYPE_GUID:72,DBTYPE_IDISPATCH:9,DBTYPE_I4:3,DBTYPE_IUNKNOWN:13,LONGVARBINARY:205,LONGVARCHAR:201,LONGVARWCHAR:203,DBTYPE_NUMERIC:131,DBTYPE_PROP_VARIANT:138,DBTYPE_R4:4,DBTYPE_I2:2,DBTYPE_I1:16,DBTYPE_UI8:21,DBTYPE_UI4:19,DBTYPE_UI2:18,DBTYPE_UI1:17,DBTYPE_UDT:132,VARBINARY:204,VARCHAR:200,DBTYPE_VARIANT:12,VARNUMERIC:139,VARWCHAR:202,DBTYPE_WSTR:130};g.CommandType={UNSPECIFIED:-1,TEXT:1,TABLE:2,STOREDPROC:4,UNKNOWN:8,FILE:256,TABLEDIRECT:512}},{"./query.js":3}],6:[function(k,h,f){var l=k("./lib/connect.js"),g=k("./lib/dbo.js"),i=k("./lib/StoredProcedures.js"),e=new l();var j=f=h.exports=function(m){return function(p,n,o){if(j.object&&n.connect){o()}else{if(j.handle(p,n,m)){o()}}}};j.dbo=g;j.spc=i;j.msc=l;j.handle=function(p,o,n){var m=false;e.setup(n);e.on("connect.success",function(r,q,s){j.object=q;o.connect=j;m=true});e.listen();o.handles.push(function(){e.destory()});return m};j.carry=function(m){if((!_.isFunction(m))||(!j.object)){return}m.call(e,j.object,g,i);return j}},{"./lib/connect.js":1,"./lib/dbo.js":4,"./lib/StoredProcedures.js":5}]},{},[6])(6)});