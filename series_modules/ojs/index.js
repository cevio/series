(function(a){if(typeof exports=="object"&&typeof module=="object"){module.exports=a(true)}else{if(typeof define=="function"&&define.amd){return define([],a)}else{window.ojs=a()}}})(function(c){var e="",d={},b=new Class(function(f){this.property("configs",_.extend(this["private"]("defaults"),f))}),a=function(f){return f.replace(/\&quot\;/g,'"').replace(/\&\#39\;/g,"'").replace(/\&gt\;/g,">").replace(/\&lt\;/g,"<").replace(/\&amp\;/g,"&")};c=!!c;b.property("defaults",{open:"<"+e+"%",close:"%"+e+">",encoding:typeof Response!=="undefined"&&Response.Charset?Response.Charset:"utf-8"});b.property("stack",function(g,f){this.buffer.push({str:g,type:f})});b.property("cutSplitBuffer",function(k){var f=this.configs.open,i=this.configs.close;var g=k.indexOf(f),j=-1;if(g>-1){this.stack(k.substring(0,g),"html");k=k.substring(g+f.length);j=k.indexOf(i);if(j>-1){var h=k.substring(0,j);if(/^\=/.test(h)){this.stack(h.substr(1),"escape")}else{if(/^\-/.test(h)){this.stack(h.substr(1),"unescape")}else{this.stack(h,"code")}}k=k.substring(j+i.length);if(k.indexOf(f)>-1){this.cutSplitBuffer(k)}else{this.stack(k,"html")}}else{throw new Error("ojs compile error: can not find the sep.close selector")}}else{this.stack(k,"html")}});b.property("parse",function(n,m,g){var l=this;var j=b.__express.ext;var k=function(h){return String(h).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/'/g,"&#39;").replace(/"/g,"&quot;")};var f=function(h){if(h&&h.length>0){h=path.resolve(path.dirname(__filename),h+(__isServer__?"."+__ext__:""));_ojs=new __ojs__(__that__.configs);return _ojs.render(h,__object__)}else{throw new Error("ojs catch error: ojs template include error: no pather or pather is empty.")}};var i='var __ojsbuf__ = [];var __ext__ = "'+j+'";var __isServer__ = '+(c?true:false)+";";i+="var escape = "+k.toString()+";";if(c){i+='var __filename = "'+g+'";'}i+="var __imports = "+f.toString()+";";i+="\nwith(__object__){\n";this.cutSplitBuffer(n);_.each(this.buffer,function(h){if(h.type!=="html"){h.str=h.str?h.str.trim():h.str}if(h.type==="escape"){i+="__ojsbuf__.push(escape("+h.str+"));"}else{if(h.type==="unescape"){i+="__ojsbuf__.push("+h.str+");"}else{if(h.type==="code"){var o,p;if(/^include/i.test(h.str)){h.str=h.str.replace(/\s+/g," ");o=h.str.split(" ").slice(1).join(" ");if(o&&o.length>0){o=path.resolve(path.dirname(g),o+(__isServer__?"."+j:""));p=new b(l.configs);i+="__ojsbuf__.push("+JSON.stringify(p.render(o,m))+");"}else{throw new Error("ojs catch error: ojs template include error: no pather or pather is empty.")}}else{if(/^import/i.test(h.str)){h.str=h.str.replace(/\s+/g," ");o=h.str.split(" ").slice(1).join(" ");i+="__ojsbuf__.push(__imports("+o+"));"}else{i+=h.str}}}else{i+="__ojsbuf__.push("+JSON.stringify(h.str)+");"}}}});i+='\n};\nreturn __ojsbuf__.join("");\n';return(new Function("__object__","__ojs__","__that__",i))(m,b,this)});b.define("getCache",function(f){return d[f]});b.define("setCache",function(f,g){d[f]=g});b.define("clear",function(f){if(d[f]){delete d[f]}});b.define("clearCache",function(){this.property("buffer",[])});b.define("render",function(h,g){var f=h;f=f.replace(/\\/g,"\\\\");if(this.getCache(f)){return this.compile(this.getCache(f),g,c?f:undefined)}else{if(c){h=fs.readFile(h,{encoding:this["private"]("configs").encoding})}else{h=a(document.getElementById(h).innerHTML)}if(this["private"]("configs").cache){this.setCache(f,h)}return this.compile(h,g,c?f:undefined)}});b.define("compile",function(h,g,f){this.clearCache();return this["private"]("parse")(h,g,f)});b.__cache=function(f){if(c){d[f]=fs.readFile(f)}else{d[f]=a(document.getElementById(f).innerHTML)}};b.__express=function(g,f,i){if("function"==typeof f){i=f,f={}}f.filename=g;var k=_.clone(f.locals||{});delete f.locals;var h=new b(f);var l;try{l=h.render(g,k)}catch(j){_.isFunction(i)&&i(j);return}_.isFunction(i)&&i(null,l)};b.__express.ext="ojs";return b});